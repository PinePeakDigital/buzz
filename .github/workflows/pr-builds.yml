name: PR Builds

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Build cross-platform binaries
        run: ./scripts/build.sh

      - name: Upload Linux AMD64
        uses: actions/upload-artifact@v4
        with:
          name: buzz-linux-amd64
          path: buzz-linux-amd64
          retention-days: 90

      - name: Upload Linux ARM64
        uses: actions/upload-artifact@v4
        with:
          name: buzz-linux-arm64
          path: buzz-linux-arm64
          retention-days: 90

      - name: Upload macOS Intel
        uses: actions/upload-artifact@v4
        with:
          name: buzz-darwin-amd64
          path: buzz-darwin-amd64
          retention-days: 90

      - name: Upload macOS Apple Silicon
        uses: actions/upload-artifact@v4
        with:
          name: buzz-darwin-arm64
          path: buzz-darwin-arm64
          retention-days: 90

      - name: Upload Windows AMD64
        uses: actions/upload-artifact@v4
        with:
          name: buzz-windows-amd64
          path: buzz-windows-amd64.exe
          retention-days: 90

      - name: Upload Windows ARM64
        uses: actions/upload-artifact@v4
        with:
          name: buzz-windows-arm64
          path: buzz-windows-arm64.exe
          retention-days: 90

      - name: Post PR comment with artifact links
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.runId;
            const repo = context.repo;
            const prNumber = context.issue.number;
            
            // Build the artifact URLs
            const artifactsUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
            
            const comment = `## 🔨 Build Artifacts
            
            Test builds are ready! Download the binaries for your platform:
            
            **All artifacts:** [View all builds](${artifactsUrl})
            
            ### Available Platforms
            
            - **Linux AMD64**: \`buzz-linux-amd64\`
            - **Linux ARM64**: \`buzz-linux-arm64\`
            - **macOS Intel**: \`buzz-darwin-amd64\`
            - **macOS Apple Silicon**: \`buzz-darwin-arm64\`
            - **Windows AMD64**: \`buzz-windows-amd64\`
            - **Windows ARM64**: \`buzz-windows-arm64\`
            
            > 💡 Click the "All artifacts" link above to download the binaries from the Actions run.
            > 
            > 🗑️ Artifacts will be automatically deleted after 90 days.`;
            
            // Check if we already posted a comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('🔨 Build Artifacts')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
